-- Prozedur: GET_LAST_BUCHUNG
-- Generiert: 2025-05-31 10:26:41

CREATE OR ALTER PROCEDURE GET_LAST_BUCHUNG
DECLARE VARIABLE KSOLL INTEGER;
DECLARE VARIABLE KHABEN INTEGER;
DECLARE VARIABLE BANKNRSOLL INTEGER;
DECLARE VARIABLE BANKNRHABEN INTEGER;
DECLARE VARIABLE BSTRSOLL VARCHAR(15);
DECLARE VARIABLE BSTRHABEN VARCHAR(15);
DECLARE VARIABLE SPLITNR INTEGER;
DECLARE VARIABLE ONRSOLL INTEGER;
DECLARE VARIABLE ONRHABEN INTEGER;
BEGIN
 IF (LETZT20 = 0) THEN
  BEGIN /* LETZTEN 20 BUCHUNGEN */
   IF (B1<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B1, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B2<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B2, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B3<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B3, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B4<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B4, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B5<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B5, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B6<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B6, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B7<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B7, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B8<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B8, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B9<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B9, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B10<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B10, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B11<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B11, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B12<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B12, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B13<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B13, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B14<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B14, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B15<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B15, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B16<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B16, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B17<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B17, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B18<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B18, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B19<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B19, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
   IF (B20<>-1) THEN
    BEGIN
     FOR
     SELECT BNR,DATUM,WDATUM,ONR,BELEGNR,KSOLLSTR,TEXT,BETRAG,MWST,KHABENSTR,BEMERKUNG,OPBETRAG, LBNR
     from get_last_buchung_bnr(:B20, :ANZEIGE)
     INTO :BNR,:DATUM,:WDATUM,:ONR,:BELEGNR,:KSOLLSTR,:TEXT,:BETRAG,:MWST,:KHABENSTR,:BEMERKUNG,:OPBETRAG,:LBNR
     DO
     SUSPEND;
    END
  END /* LETZTEN 20 BUCHUNGEN */
ELSE
 BEGIN /* ZEITRAUM */
 IF (ANZEIGE='2') THEN      /* Anzeige doppelte BuchfÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¼hrung alle = split*/
  BEGIN
   if (:AKTHAUS <> -1) then  /* nur ein Haus */
   BEGIN
    FOR SELECT
    BNR,DATUM,WDATUM,ONRSOLL, ONRHABEN, BELEGNR, KSOLL, TEXT, BETRAG, OPBETRAG, MWST, KHABEN, BANKNRSOLL, BANKNRHABEN,
    BSTRSOLL, BSTRHABEN, SPLITNR, LBNR
    FROM BUCHUNG
    WHERE DATUM>=:ABDATUM AND (ONRSOLL=:AKTHAUS or ONRHABEN=:AKTHAUS) and BETRAG<>0
    ORDER BY 1 descending
    INTO
     :BNR, :DATUM, :WDATUM, :ONRSOLL, :ONRHABEN, :BELEGNR, :KSOLL,:TEXT, :BETRAG, :OPBETRAG, :MWST, :KHABEN, :BANKNRSOLL, :BANKNRHABEN,
     :BSTRSOLL, :BSTRHABEN, :SPLITNR, :LBNR
    DO
     BEGIN
      SELECT SUBSTRING(KNRSTR || ' ' || KBEZ FROM 1 FOR 120) from konten where ONR=:ONRSOLL AND KNR=:KSOLL
      into :KSOLLSTR;
      SELECT SUBSTRING(KNRSTR || ' ' || KBEZ FROM 1 FOR 120) from konten where ONR=:ONRHABEN AND KNR=:KHABEN
      into :KHABENSTR;
      IF (:BANKNRSOLL IS NOT NULL) THEN
       KSOLLSTR = KSOLLSTR || ' ' || BSTRSOLL;
      IF (:BANKNRHABEN IS NOT NULL) THEN
       KHABENSTR = KHABENSTR || ' ' || BSTRHABEN;
      IF (ONRSOLL = 0) THEN
       ONR=ONRHABEN;
      ELSE
       ONR=ONRSOLL;
      IF (ONR=0) THEN
       ONR=NULL;
      IF (:OPBETRAG IS NOT NULL) THEN
       BEGIN
        IF (:OPBETRAG=0) THEN
         BEGIN
          IF (:SPLITNR IS NULL) THEN
           BEMERKUNG='SO';
          ELSE
           BEMERKUNG='SO..';         
         END
        ELSE
         BEGIN
          IF (:SPLITNR IS NULL) THEN
           BEMERKUNG='OP';
          ELSE
           BEMERKUNG='OP..';
         END  
       END
      ELSE
       BEGIN
        IF (:SPLITNR IS NOT NULL) THEN
         BEMERKUNG='..';
        ELSE
         BEMERKUNG=NULL;
       END
      SUSPEND;
     END
   END
   ELSE
    BEGIN  /* Alle HÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤user */
    FOR SELECT
    BNR,DATUM,WDATUM,ONRSOLL, ONRHABEN, BELEGNR, KSOLL, TEXT, BETRAG, OPBETRAG, MWST, KHABEN, BANKNRSOLL, BANKNRHABEN,
    BSTRSOLL, BSTRHABEN, SPLITNR, LBNR
    FROM BUCHUNG
    WHERE DATUM>=:ABDATUM and BETRAG<>0
    INTO
     :BNR, :DATUM, :WDATUM, :ONRSOLL, :ONRHABEN, :BELEGNR, :KSOLL,:TEXT, :BETRAG, :OPBETRAG, :MWST, :KHABEN, :BANKNRSOLL, :BANKNRHABEN,
     :BSTRSOLL, :BSTRHABEN, :SPLITNR, :LBNR
    DO
     BEGIN
      SELECT SUBSTRING(KNRSTR || ' ' || KBEZ FROM 1 FOR 120) from konten where ONR=:ONRSOLL AND KNR=:KSOLL
      into :KSOLLSTR;
      SELECT SUBSTRING(KNRSTR || ' ' || KBEZ FROM 1 FOR 120) from konten where ONR=:ONRHABEN AND KNR=:KHABEN
      into :KHABENSTR;
      IF (:BANKNRSOLL IS NOT NULL) THEN
       KSOLLSTR = KSOLLSTR || ' ' || BSTRSOLL;
      IF (:BANKNRHABEN IS NOT NULL) THEN
       KHABENSTR = KHABENSTR || ' ' || BSTRHABEN;
      IF (ONRSOLL = 0) THEN
       ONR=ONRHABEN;
      ELSE
       ONR=ONRSOLL;
      IF (ONR=0) THEN
       ONR=NULL;
      IF (:OPBETRAG IS NOT NULL) THEN
       BEGIN
        IF (:OPBETRAG=0) THEN
         BEGIN
          IF (:SPLITNR IS NULL) THEN
           BEMERKUNG='SO';
          ELSE
           BEMERKUNG='SO..';         
         END
        ELSE
         BEGIN
          IF (:SPLITNR IS NULL) THEN
           BEMERKUNG='OP';
          ELSE
           BEMERKUNG='OP..';
         END  
       END
      ELSE
       BEGIN
        IF (:SPLITNR IS NOT NULL) THEN
         BEMERKUNG='..';
        ELSE
         BEMERKUNG=NULL;
       END
      SUSPEND;
     END
    END
  END
 ELSE
 IF (ANZEIGE=1) THEN       /* DOPPELTE BUCHFÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“HRUNG SPLIT ZUSAMMENGEFASST */
  BEGIN
   if (:AKTHAUS <> -1) then  /* nur ein Haus */
   BEGIN
    FOR SELECT
    BNR,DATUM,WDATUM,ONRSOLL, ONRHABEN, BELEGNR, KSOLL, TEXT, BETRAG, OPBETRAG, MWST, KHABEN, BANKNRSOLL, BANKNRHABEN,
    BSTRSOLL, BSTRHABEN, SPLITNR, LBNR
    FROM BUCHUNG
    WHERE DATUM>=:ABDATUM AND (ONRSOLL=:AKTHAUS or ONRHABEN=:AKTHAUS) AND SPLITNR IS NULL and BETRAG<>0
    UNION
    SELECT
    buchung.BNR,DATUM,WDATUM,ONRSOLL, ONRHABEN, BELEGNR, KSOLL, TEXT, splitbuch.BETRAG, splitbuch.OPBETRAG, MWST, KHABEN, BANKNRSOLL, BANKNRHABEN,
    BSTRSOLL, BSTRHABEN, SPLITNR, LBNR
    FROM BUCHUNG, SPLITBUCH
    WHERE DATUM>=:ABDATUM AND (ONRSOLL=:AKTHAUS or ONRHABEN=:AKTHAUS) AND SPLITNR IS NOT NULL and splitbuch.BETRAG<>0
    AND BUCHUNG.BNR = SPLITBUCH.BNR
    INTO
     :BNR, :DATUM, :WDATUM, :ONRSOLL, :ONRHABEN, :BELEGNR, :KSOLL,:TEXT, :BETRAG, :OPBETRAG, :MWST, :KHABEN, :BANKNRSOLL, :BANKNRHABEN, :BSTRSOLL, :BSTRHABEN,
     :SPLITNR, :LBNR
    DO
     BEGIN
      SELECT SUBSTRING(KNRSTR || ' ' || KBEZ FROM 1 FOR 120) from konten where ONR=:ONRSOLL AND KNR=:KSOLL
      into :KSOLLSTR;
      SELECT SUBSTRING(KNRSTR || ' ' || KBEZ FROM 1 FOR 120) from konten where ONR=:ONRHABEN AND KNR=:KHABEN
      into :KHABENSTR;
      IF (:BANKNRSOLL IS NOT NULL) THEN
       KSOLLSTR = KSOLLSTR || ' ' || BSTRSOLL;
      IF (:BANKNRHABEN IS NOT NULL) THEN
       KHABENSTR = KHABENSTR || ' ' || BSTRHABEN;
      IF (ONRSOLL = 0) THEN
       ONR=ONRHABEN;
      ELSE
       ONR=ONRSOLL;
      IF (ONR=0) THEN
       ONR=NULL;
      IF (:OPBETRAG IS NOT NULL) THEN
       BEGIN
        IF (:OPBETRAG=0) THEN
         BEGIN
          IF (:SPLITNR IS NULL) THEN
           BEMERKUNG='SO';
          ELSE
           BEMERKUNG='SO..';         
         END
        ELSE
         BEGIN
          IF (:SPLITNR IS NULL) THEN
           BEMERKUNG='OP';
          ELSE
           BEMERKUNG='OP..';
         END  
       END
      ELSE
       BEGIN
        IF (:SPLITNR IS NOT NULL) THEN
         BEMERKUNG='..';
        ELSE
         BEMERKUNG=NULL;
       END
      SUSPEND;
     END
   END
   ELSE
    BEGIN  /* alle HÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤user */
    FOR SELECT
    BNR,DATUM,WDATUM,ONRSOLL, ONRHABEN, BELEGNR, KSOLL, TEXT, BETRAG, OPBETRAG, MWST, KHABEN, BANKNRSOLL, BANKNRHABEN,
    BSTRSOLL, BSTRHABEN, SPLITNR, LBNR
    FROM BUCHUNG
    WHERE DATUM>=:ABDATUM AND SPLITNR IS NULL and BETRAG<>0
    UNION
    SELECT
    buchung.BNR,DATUM,WDATUM,ONRSOLL, ONRHABEN, BELEGNR, KSOLL, TEXT, splitbuch.BETRAG, splitbuch.OPBETRAG, MWST, KHABEN, BANKNRSOLL, BANKNRHABEN,
    BSTRSOLL, BSTRHABEN, SPLITNR, LBNR
    FROM BUCHUNG, SPLITBUCH
    WHERE DATUM>=:ABDATUM AND SPLITNR IS NOT NULL and splitbuch.BETRAG<>0
    AND BUCHUNG.BNR = SPLITBUCH.BNR
    INTO
     :BNR, :DATUM, :WDATUM, :ONRSOLL, :ONRHABEN, :BELEGNR, :KSOLL,:TEXT, :BETRAG, :OPBETRAG, :MWST, :KHABEN, :BANKNRSOLL, :BANKNRHABEN, :BSTRSOLL, :BSTRHABEN,
     :SPLITNR, :LBNR
    DO
     BEGIN
      SELECT SUBSTRING(KNRSTR || ' ' || KBEZ FROM 1 FOR 120) from konten where ONR=:ONRSOLL AND KNR=:KSOLL
      into :KSOLLSTR;
      SELECT SUBSTRING(KNRSTR || ' ' || KBEZ FROM 1 FOR 120) from konten where ONR=:ONRHABEN AND KNR=:KHABEN
      into :KHABENSTR;
      IF (:BANKNRSOLL IS NOT NULL) THEN
       KSOLLSTR = KSOLLSTR || ' ' || BSTRSOLL;
      IF (:BANKNRHABEN IS NOT NULL) THEN
       KHABENSTR = KHABENSTR || ' ' || BSTRHABEN;
      IF (ONRSOLL = 0) THEN
       ONR=ONRHABEN;
      ELSE
       ONR=ONRSOLL;
      IF (ONR=0) THEN
       ONR=NULL;
      IF (:OPBETRAG IS NOT NULL) THEN
       BEGIN
        IF (:OPBETRAG=0) THEN
         BEGIN
          IF (:SPLITNR IS NULL) THEN
           BEMERKUNG='SO';
          ELSE
           BEMERKUNG='SO..';         
         END
        ELSE
         BEGIN
          IF (:SPLITNR IS NULL) THEN
           BEMERKUNG='OP';
          ELSE
           BEMERKUNG='OP..';
         END  
       END
      ELSE
       BEGIN
        IF (:SPLITNR IS NOT NULL) THEN
         BEMERKUNG='..';
        ELSE
         BEMERKUNG=NULL;
       END
      SUSPEND;
     END
    END    /* alle HÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤user */
  END   /* DOPPELTE BUCHFÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“HRUNG SPLIT ZUSAMMENGEFASST */
 ELSE
 IF (ANZEIGE=0) THEN       /* EINFACHE BUCHFÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“HRUNG nur Bankbuchungen ANZEIGEN */
  BEGIN
   if (:AKTHAUS <> -1) then
   BEGIN
    FOR SELECT
    BNR,DATUM,WDATUM,ONRSOLL, ONRHABEN, BELEGNR, KSOLL, TEXT, BETRAG, MWST, KHABEN, BANKNRSOLL, BANKNRHABEN, BSTRSOLL, BSTRHABEN,
    SPLITNR, LBNR
    FROM BUCHUNG
    WHERE DATUM>=:ABDATUM AND (ONRSOLL=:AKTHAUS OR ONRHABEN=:AKTHAUS) AND (ARTSOLL=20 OR ARTHABEN=20) AND SPLITNR IS NULL AND LBNR IS NULL and Betrag<>0
    UNION
    SELECT buchung.BNR,DATUM,WDATUM,ONRSOLL, ONRHABEN, BELEGNR, KSOLL, TEXT, splitbuch.BETRAG, MWST, KHABEN, BANKNRSOLL, BANKNRHABEN, BSTRSOLL, BSTRHABEN,
    SPLITNR, LBNR
    FROM BUCHUNG, SPLITBUCH
    WHERE DATUM>=:ABDATUM AND (ONRSOLL=:AKTHAUS OR ONRHABEN=:AKTHAUS) AND (ARTSOLL=20 OR ARTHABEN=20) AND SPLITNR IS NOT NULL AND LBNR IS NULL and splitbuch.Betrag<>0
    and BUCHUNG.BNR=SPLITBUCH.BNR
    INTO
     :BNR, :DATUM, :WDATUM, :ONRSOLL, :ONRHABEN, :BELEGNR, :KSOLL,:TEXT, :BETRAG, :MWST, :KHABEN, :BANKNRSOLL, :BANKNRHABEN, :BSTRSOLL, :BSTRHABEN,
     :SPLITNR, :LBNR
    DO
     BEGIN
      IF (BANKNRSOLL IS NOT NULL AND BANKNRHABEN IS NOT NULL) THEN
       BEGIN
        KSOLLSTR=:BSTRSOLL;
        KHABENSTR=:BSTRHABEN;
       END
      ELSE
       IF (BANKNRSOLL IS NOT NULL) THEN
        BEGIN
         KHABENSTR=:BSTRSOLL;
         SELECT SUBSTRING(KNRSTR || ' ' || KBEZ FROM 1 FOR 120) from konten where ONR=:ONRHABEN AND KNR=:KHABEN
         into :KSOLLSTR;
         ONR=:ONRHABEN;
        END
      ELSE
       IF (BANKNRHABEN IS NOT NULL) THEN
        BEGIN
         KHABENSTR=:BSTRHABEN;
         SELECT SUBSTRING(KNRSTR || ' ' || KBEZ FROM 1 FOR 120) from konten where ONR=:ONRSOLL AND KNR=:KSOLL
         into :KSOLLSTR;
         ONR=:ONRSOLL;
        END
      IF (ONR = 0) THEN
       ONR=NULL;
      IF (:OPBETRAG IS NOT NULL) THEN
       BEGIN
        IF (:OPBETRAG=0) THEN
         BEGIN
          IF (:SPLITNR IS NULL) THEN
           BEMERKUNG='SO';
          ELSE
           BEMERKUNG='SO..';         
         END
        ELSE
         BEGIN
          IF (:SPLITNR IS NULL) THEN
           BEMERKUNG='OP';
          ELSE
           BEMERKUNG='OP..';
         END  
       END
      ELSE
       BEGIN
        IF (:SPLITNR IS NOT NULL) THEN
         BEMERKUNG='..';
        ELSE
         BEMERKUNG=NULL;
       END
      SUSPEND;
     END
    /* Jetzt noch die Sammler */
    FOR SELECT
    LBNR, DATUM, ONR, BELEGNR, TEXT, BETRAG, BANKNR, LBNR
    FROM SLEVBUCH
    WHERE DATUM>=:ABDATUM AND OPBETRAG IS NULL
    INTO
     :BNR, :DATUM, :ONR, :BELEGNR, :TEXT, :BETRAG, :BANKNRHABEN, :LBNR
    DO
     BEGIN
      /* LEV von diesem Haus? */
      SELECT ONR from objbanken where ONR=:AKTHAUS and BANKNR=:BANKNRHABEN
      into :ONR;
      if (ONR=AKTHAUS) THEN
       BEGIN
        SELECT KURZBEZ from banken where NR=:BANKNRHABEN
        into :KHABENSTR;
        KSOLLSTR=NULL;
        BEMERKUNG='SLE';
        ONR=:AKTHAUS;
        WDATUM=DATUM;
        SUSPEND;
       END
     END
   END
  ELSE
   BEGIN  /* alle HÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤user */
   FOR SELECT
    BNR,DATUM,WDATUM,ONRSOLL, ONRHABEN, BELEGNR, KSOLL, TEXT, BETRAG, MWST, KHABEN, BANKNRSOLL, BANKNRHABEN, BSTRSOLL, BSTRHABEN,
    SPLITNR, LBNR
    FROM BUCHUNG
    WHERE DATUM>=:ABDATUM AND (ARTSOLL=20 OR ARTHABEN=20) AND SPLITNR IS NULL AND LBNR IS NULL
    UNION
    SELECT buchung.BNR,DATUM,WDATUM,ONRSOLL, ONRHABEN, BELEGNR, KSOLL, TEXT, splitbuch.BETRAG, MWST, KHABEN, BANKNRSOLL, BANKNRHABEN, BSTRSOLL, BSTRHABEN,
    SPLITNR, LBNR
    FROM BUCHUNG, SPLITBUCH
    WHERE DATUM>=:ABDATUM AND (ARTSOLL=20 OR ARTHABEN=20) AND SPLITNR IS NOT NULL AND LBNR IS NULL
    and BUCHUNG.BNR=SPLITBUCH.BNR
    INTO
     :BNR, :DATUM, :WDATUM, :ONRSOLL, :ONRHABEN, :BELEGNR, :KSOLL,:TEXT, :BETRAG, :MWST, :KHABEN, :BANKNRSOLL, :BANKNRHABEN, :BSTRSOLL, :BSTRHABEN,
     :SPLITNR, :LBNR
    DO
     BEGIN
      IF (BANKNRSOLL IS NOT NULL AND BANKNRHABEN IS NOT NULL) THEN
       BEGIN
        KSOLLSTR=:BSTRSOLL;
        KHABENSTR=:BSTRHABEN;
       END
      ELSE
       IF (BANKNRSOLL IS NOT NULL) THEN
        BEGIN
         KHABENSTR=:BSTRSOLL;
         SELECT SUBSTRING(KNRSTR || ' ' || KBEZ FROM 1 FOR 120) from konten where ONR=:ONRHABEN AND KNR=:KHABEN
         into :KSOLLSTR;
         ONR=:ONRHABEN;
        END
      ELSE
       IF (BANKNRHABEN IS NOT NULL) THEN
        BEGIN
         KHABENSTR=:BSTRHABEN;
         SELECT SUBSTRING(KNRSTR || ' ' || KBEZ FROM 1 FOR 120) from konten where ONR=:ONRSOLL AND KNR=:KSOLL
         into :KSOLLSTR;
         ONR=:ONRSOLL;
        END
      IF (ONR = 0) THEN
       ONR=NULL;
      IF (:OPBETRAG IS NOT NULL) THEN
       BEGIN
        IF (:OPBETRAG=0) THEN
         BEGIN
          IF (:SPLITNR IS NULL) THEN
           BEMERKUNG='SO';
          ELSE
           BEMERKUNG='SO..';         
         END
        ELSE
         BEGIN
          IF (:SPLITNR IS NULL) THEN
           BEMERKUNG='OP';
          ELSE
           BEMERKUNG='OP..';
         END  
       END
      ELSE
       BEGIN
        IF (:SPLITNR IS NOT NULL) THEN
         BEMERKUNG='..';
        ELSE
         BEMERKUNG=NULL;
       END
      SUSPEND;
     END
    /* Jetzt noch die Sammler */
    FOR SELECT
    LBNR, DATUM, ONR, BELEGNR, TEXT, BETRAG, BANKNR, LBNR
    FROM SLEVBUCH
    WHERE DATUM>=:ABDATUM AND OPBETRAG IS NULL
    INTO
     :BNR, :DATUM, :ONR, :BELEGNR, :TEXT, :BETRAG, :BANKNRHABEN, :LBNR
    DO
     BEGIN
      SELECT KURZBEZ from banken where NR=:BANKNRHABEN
      into :KHABENSTR;
      for SELECT ONR from objbanken where BANKNR=:BANKNRHABEN
      into :ONR do
      KSOLLSTR=NULL;
      BEMERKUNG='SLE';
      WDATUM=DATUM;
      SUSPEND;
     END
   END   /* alle HÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤user */
  END  /* EINFACHE BUCHFÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Â ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“HRUNG */
 END /* ZEITRAUM */
END
