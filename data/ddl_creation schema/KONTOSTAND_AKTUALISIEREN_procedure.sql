-- Prozedur: KONTOSTAND_AKTUALISIEREN
-- Generiert: 2025-05-31 10:26:42

CREATE OR ALTER PROCEDURE KONTOSTAND_AKTUALISIEREN
declare variable DVON DATE;
declare variable DBIS DATE;
declare variable IKKSTNR INTEGER;
declare variable IKKLASSE INTEGER;
declare variable RBETRAG NUMERIC(15,2);
declare variable IM_WS CHAR(1);
BEGIN
 IF (KNR IS NOT NULL AND BETRAG<>0) THEN
  BEGIN
  /* VORZEICHEN SOLL SETZEN */
  IM_WS='J';
  IF ((ART>=10 AND ART<=19) OR (ART=27) OR (ART=71)) THEN
   BEGIN
    IF (ISSOLL='J') THEN
      RBETRAG=-BETRAG;
    ELSE
      RBETRAG=BETRAG;
   END
  ELSE
   BEGIN
    IF (ISSOLL='J') THEN
      RBETRAG=BETRAG;
    ELSE
      RBETRAG=-BETRAG;
   END
  IF (ART<=19) THEN
   BEGIN
    /* IM WIRTSCHAFTSJAHR? */
    SELECT KKSTNR, KKLASSE FROM KONTEN
    WHERE ONR = :ONR AND KNR = :KNR
    INTO :IKKSTNR, :IKKLASSE;
    IF (IKKSTNR <>2) then
     BEGIN
      SELECT BKVON, BKBIS from OBJEKTE
      WHERE ONR=:ONR
      INTO :DVON, :DBIS;
     END
    ELSE
     BEGIN
      SELECT HKVON, HKBIS from OBJEKTE
      WHERE ONR=:ONR
      INTO :DVON, :DBIS;
     end
    IF (NOT (DATUM>=:DVON and DATUM<=:DBIS)) THEN
     IM_WS='N';
   END
  IF (IM_WS='J' OR IKKLASSE>19) THEN
   UPDATE KONTEN SET KONTEN.KBRUTTO = KONTEN.KBRUTTO + :RBETRAG, KONTEN.KBRUTTOWJ = KONTEN.KBRUTTOWJ + :RBETRAG WHERE
          KONTEN.ONR = :ONR AND KONTEN.KNR = :KNR;
  ELSE
   UPDATE KONTEN SET KONTEN.KBRUTTO = KONTEN.KBRUTTO + :RBETRAG WHERE
          KONTEN.ONR = :ONR AND KONTEN.KNR = :KNR;
  /*   BANKKONTO KSTAND aktualisieren */
  IF (BANKNR IS NOT NULL) THEN
   UPDATE BANKEN SET BANKEN.KSTAND = BANKEN.KSTAND + :RBETRAG WHERE
          BANKEN.NR = :BANKNR;
 END
END
