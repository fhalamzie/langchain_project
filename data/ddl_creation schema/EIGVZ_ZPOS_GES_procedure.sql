-- Prozedur: EIGVZ_ZPOS_GES
-- Generiert: 2025-05-31 10:26:42

CREATE OR ALTER PROCEDURE EIGVZ_ZPOS_GES
DECLARE VARIABLE KKLASSE INTEGER;
DECLARE VARIABLE SUMSOLL NUMERIC(15, 2);
DECLARE VARIABLE SUMHABEN NUMERIC(15, 2);
DECLARE VARIABLE SUMSOLL_NETTO NUMERIC(15, 2);
DECLARE VARIABLE SUMHABEN_NETTO NUMERIC(15, 2);
DECLARE VARIABLE DTVONBDATUM DATE;
DECLARE VARIABLE DTBISBDATUM DATE;
DECLARE VARIABLE DTVONWDATUM DATE;
DECLARE VARIABLE DTBISWDATUM DATE;
BEGIN


/* TEMP 
  IONR = 7;
  DTVON = '1.1.2019';
  DTBIS = '31.12.2019';
  BISTVZ = 'N';
  ZPOS = 110;
  WDATUM = 'N';
  TEMP */

 /* W_Datum abfragen */
 if (WDATUM = 'N') then
  begin
   DTVONBDATUM = DTVON;
   DTBISBDATUM = DTBIS;
   DTVONWDATUM = '01.01.1900';
   DTBISWDATUM = '01.01.1900';
  end
 else
  begin
   DTVONBDATUM = '01.01.1900';
   DTBISBDATUM = '01.01.1900';
   DTVONWDATUM = DTVON;
   DTBISWDATUM = DTBIS;
  end

 IF (BISTVZ='J') THEN
  BEGIN
   /*            */
   /* KEIN SPLIT */
   /*            */
   /* SOLL */
   SELECT SUM(BETRAG), SUM((BETRAG*100) / (100+MWSTOP)) from buchung
   WHERE ONRSOLL=:IONR
   AND ARTOP=:ZPOS
   AND ((Datum >= :DTVONBDATUM and Datum <= :DTBISBDATUM) or (WDatum >= :DTVONWDATUM and WDatum <= :DTBISWDATUM))
   INTO :SUMSOLL, SUMSOLL_NETTO;
   /* HABEN */
   SELECT SUM(BETRAG), SUM((BETRAG*100) / (100+MWSTOP)) from buchung
   WHERE ONRHABEN=:IONR
   AND ARTOP=:ZPOS
   AND ((Datum >= :DTVONBDATUM and Datum <= :DTBISBDATUM) or (WDatum >= :DTVONWDATUM and WDatum <= :DTBISWDATUM))
   INTO :SUMHABEN, SUMHABEN_NETTO;
   IF (SUMSOLL IS NULL) THEN
    SUMSOLL=0;
   IF (SUMHABEN IS NULL) THEN
    SUMHABEN=0;
   IF (SUMSOLL_NETTO IS NULL) THEN
    SUMSOLL_NETTO=0;
   IF (SUMHABEN_NETTO IS NULL) THEN
    SUMHABEN_NETTO=0;
   SUM_VZ=SUMHABEN-SUMSOLL;
   SUM_VZ_NETTO=SUMHABEN_NETTO-SUMSOLL_NETTO;
   /*            */
   /*   SPLIT    */
   /*            */
   /* SOLL */
   select Sum(buchzahl.Betrag), SUM((buchzahl.BETRAG*100) / (100+buchzahl.MWSTOP)) from buchung, buchzahl
   where  ONRSOLL=:IONR AND KSOLL>199999
   AND ((Datum >= :DTVONBDATUM and Datum <= :DTBISBDATUM) or (WDatum >= :DTVONWDATUM and WDatum <= :DTBISWDATUM))
   and buchung.artop=0
   and buchung.bnr=buchzahl.bnr
   and buchzahl.artop=:ZPOS
   INTO :SUMSOLL, SUMSOLL_NETTO;
   /* Haben */
   select Sum(buchzahl.Betrag), SUM((buchzahl.BETRAG*100) / (100+buchzahl.MWSTOP)) from buchung, buchzahl
   where  ONRHABEN=:IONR AND KHABEN>199999
   AND ((Datum >= :DTVONBDATUM and Datum <= :DTBISBDATUM) or (WDatum >= :DTVONWDATUM and WDatum <= :DTBISWDATUM))
   and buchung.artop=0
   and buchung.bnr=buchzahl.bnr
   and buchzahl.artop=:ZPOS
   INTO :SUMHABEN, SUMHABEN_NETTO;
   IF (SUMSOLL IS NULL) THEN
    SUMSOLL=0;
   IF (SUMHABEN IS NULL) THEN
    SUMHABEN=0;
   IF (SUMSOLL_NETTO IS NULL) THEN
    SUMSOLL_NETTO=0;
   IF (SUMHABEN_NETTO IS NULL) THEN
    SUMHABEN_NETTO=0;
   SUM_VZ=SUM_VZ+SUMHABEN-SUMSOLL;
   SUM_VZ_NETTO=SUM_VZ_NETTO+SUMHABEN_NETTO-SUMSOLL_NETTO;
  END
 ELSE
  BEGIN
   /* SOLL VZ */
   SELECT SUM(BETRAG), SUM((BETRAG*100) / (100+MWST)) from buchung
   WHERE (ONRSOLL=:IONR) AND (ONRHABEN=:IONR and ARTHABEN=:ZPOS)
   AND OPNR IS NOT NULL and OPBETRAG IS NOT NULL AND ((Datum >= :DTVONBDATUM and Datum <= :DTBISBDATUM) or (WDatum >= :DTVONWDATUM and WDatum <= :DTBISWDATUM))
   INTO :SUMHABEN, SUMHABEN_NETTO;
   /* HABEN */
   SELECT SUM(BETRAG), SUM((BETRAG*100) / (100+MWST)) from buchung
   WHERE (ONRHABEN=:IONR) AND (ONRSOLL=:IONR and ARTSOLL=:ZPOS)
   AND OPNR IS NOT NULL and OPBETRAG IS NOT NULL AND ((Datum >= :DTVONBDATUM and Datum <= :DTBISBDATUM) or (WDatum >= :DTVONWDATUM and WDatum <= :DTBISWDATUM))
   INTO :SUMSOLL, SUMSOLL_NETTO;
   IF (SUMSOLL IS NULL) THEN
    SUMSOLL=0;
   IF (SUMHABEN IS NULL) THEN
    SUMHABEN=0;
   IF (SUMSOLL_NETTO IS NULL) THEN
    SUMSOLL_NETTO=0;
   IF (SUMHABEN_NETTO IS NULL) THEN
    SUMHABEN_NETTO=0;
   SUM_VZ=SUMHABEN-SUMSOLL;
   SUM_VZ_NETTO=SUMHABEN_NETTO-SUMSOLL_NETTO;
  END    /* SOLL VZ */
 SUSPEND;
END
