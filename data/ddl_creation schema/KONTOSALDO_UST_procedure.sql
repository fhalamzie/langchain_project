-- Prozedur: KONTOSALDO_UST
-- Generiert: 2025-05-31 10:26:41

CREATE OR ALTER PROCEDURE KONTOSALDO_UST
DECLARE VARIABLE MWST NUMERIC(15, 4);
DECLARE VARIABLE NETTO NUMERIC(15, 2);
DECLARE VARIABLE BRUTTO NUMERIC(15, 2);
DECLARE VARIABLE NR INTEGER;
DECLARE VARIABLE BFOUND CHAR(1);
DECLARE VARIABLE DTBDATUMVON DATE;
DECLARE VARIABLE DTBDATUMBIS DATE;
DECLARE VARIABLE DTWDATUMVON DATE;
DECLARE VARIABLE DTWDATUMBIS DATE;
BEGIN
 SALDONETTO=0;
 SALDO=0;
 NR=1;
 MWST1=0; MWST2=7; MWST3=16; MWST4=19; MWST5=0; MWST6=0;
 NETTO1=0; NETTO2=0; NETTO3=0; NETTO4=0; NETTO5=0; NETTO6=0;
 if (BWDATUM = 'N') then
  begin
   DTBDATUMVON = DTVON;
   DTBDATUMBIS = DTBIS;
   DTWDATUMVON = '01.01.1900';
   DTWDATUMBIS = '01.01.1900';
  end
 else
  begin
   DTWDATUMVON = DTVON;
   DTWDATUMBIS = DTBIS;
   DTBDATUMVON = '01.01.1900';
   DTBDATUMBIS = '01.01.1900';
  end 
 /* SOLL */
 FOR
  SELECT MWST, Sum(Betrag), SUM((Betrag*100) / (100+MWST)) from buchung
  WHERE ONRSOLL=:IONR and KSOLL=:IKNR
  AND ((DATUM>=:DTBDATUMVON and DATUM<=:DTBDATUMBIS) or (WDATUM>=:DTWDATUMVON and WDATUM<=:DTWDATUMBIS))
  GROUP BY MWST ORDER BY MWST
 INTO :MWST, BRUTTO, :NETTO
 DO
  BEGIN
   SALDONETTO = SALDONETTO + NETTO;
   SALDO = SALDO + BRUTTO;
   IF (NR = 1) THEN
    BEGIN
     NETTO1 = NETTO;
     MWST1 = MWST;
    END
   IF (NR = 2) THEN
    BEGIN
     NETTO2 = NETTO;
     MWST2 = MWST;
    END
   IF (NR = 3) THEN
    BEGIN
     NETTO3 = NETTO;
     MWST3 = MWST;
    END
   IF (NR = 4) THEN
    BEGIN
     NETTO4 = NETTO;
     MWST4 = MWST;
    END
   IF (NR = 5) THEN
    BEGIN
     NETTO5 = NETTO;
     MWST5 = MWST;
    END
   IF (NR = 6) THEN
    BEGIN
     NETTO6 = NETTO;
     MWST6 = MWST;
    END
   NR = NR + 1;
  END
 /*HABEN */
 FOR
  SELECT MWST, Sum(Betrag), SUM((Betrag*100) / (100+MWST)) from buchung
  WHERE ONRHABEN=:IONR and KHABEN=:IKNR
  AND ((DATUM>=:DTBDATUMVON and DATUM<=:DTBDATUMBIS) or (WDATUM>=:DTWDATUMVON and WDATUM<=:DTWDATUMBIS))
  GROUP BY MWST ORDER BY MWST
 INTO :MWST, BRUTTO, :NETTO
 DO
  BEGIN
   BFOUND = 'N';
   SALDONETTO = SALDONETTO - NETTO;
   SALDO = SALDO - BRUTTO;
   IF ((MWST = MWST1) AND (BFOUND = 'N')) THEN
    BEGIN
     NETTO1 = NETTO1 - NETTO;
     BFOUND = 'J';
    END
   IF ((MWST = MWST2) AND (BFOUND = 'N')) THEN
    BEGIN
     NETTO2 = NETTO2 - NETTO;
     BFOUND = 'J';
    END
   IF ((MWST = MWST3) AND (BFOUND = 'N')) THEN
    BEGIN
     NETTO3=NETTO3 - NETTO;
     BFOUND = 'J';
    END
   IF ((MWST = MWST4) AND (BFOUND = 'N')) THEN
    BEGIN
     NETTO4 = NETTO4 - NETTO;
     BFOUND = 'J';
    END
   IF ((MWST = MWST5) AND (BFOUND = 'N')) THEN
    BEGIN
     NETTO5 = NETTO5 - NETTO;
     BFOUND = 'J';
    END
   IF ((MWST = MWST6) AND (BFOUND = 'N')) THEN
    BEGIN
     NETTO6 = NETTO6 - NETTO;
     BFOUND = 'J';
    END
  END
 SUSPEND;
END
