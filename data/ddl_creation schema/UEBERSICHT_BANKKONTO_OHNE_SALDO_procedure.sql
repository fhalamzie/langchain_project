-- Prozedur: UEBERSICHT_BANKKONTO_OHNE_SALDO
-- Generiert: 2025-05-31 10:26:42

CREATE OR ALTER PROCEDURE UEBERSICHT_BANKKONTO_OHNE_SALDO
DECLARE VARIABLE Betrag NUMERIC(15, 2);
DECLARE VARIABLE ONRSOLL INTEGER;
DECLARE VARIABLE ONRHABEN INTEGER;
DECLARE VARIABLE KSTRSOLL VARCHAR(18);
DECLARE VARIABLE KSTRHABEN VARCHAR(18);
DECLARE VARIABLE KSOLL INTEGER;
DECLARE VARIABLE KHABEN INTEGER;
DECLARE VARIABLE IBANKNRSOLL INTEGER;
DECLARE VARIABLE IBANKNRHABEN INTEGER;
DECLARE VARIABLE ARTOP INTEGER;
DECLARE VARIABLE ARTSOLL INTEGER;
DECLARE VARIABLE ANZ INTEGER;
DECLARE VARIABLE IGN INTEGER;
DECLARE VARIABLE IOPNR INTEGER;
BEGIN
 FOR
  SELECT DATUM,BELEGNR,KAUSZUGNR,KAUSZUGBLATT,TEXT,MWST,BNR,BETRAG,LBNR,BANKNRSOLL,BANKNRHABEN, ONRSOLL,ONRHABEN,KSOLL,KHABEN,KSTRSOLL,KSTRHABEN, ARTOP, ARTSOLL, OPNR from buchung
   WHERE (BANKNRSOLL=:GKONTO or BANKNRHABEN=:GKONTO)
   AND (Datum>=:DTVON AND DATUM<=:DTBIS)
   AND LBNR IS NULL 
  INTO :DATUM, :BELEG, :KAUSZ,:BLATTNR,:BUCHUNGSTEXT,:UST,:BNR,:BETRAG, :LBNR, :IBANKNRSOLL,:IBANKNRHABEN, :ONRSOLL, :ONRHABEN, :KSOLL, :KHABEN, :KSTRSOLL, :KSTRHABEN, :ARTOP, :ARTSOLL, :IOPNR
  DO
   BEGIN
    IF (:IBANKNRSOLL=:GKONTO) THEN 
     BEGIN
      HAUS=ONRSOLL;
      IKONTO=KHABEN;
      KONTO=KSTRHABEN;
      IF (BETRAG<0) THEN  /* negative einnahme = ausgabe */
       BEGIN
        EINNAHME=0;
        AUSGABE=-BETRAG;
        SH='-';
       END
      ELSE
       BEGIN
        EINNAHME=BETRAG;
        AUSGABE=0;
        SH='+';
       END
     END
    ELSE
     BEGIN
      HAUS=ONRHABEN;
      IKONTO=KSOLL;
      KONTO=KSTRSOLL;
      IF (BETRAG<0) THEN /* NEGATIVE AUSGABE = EINNAHME */
       BEGIN
        EINNAHME=-BETRAG;
        AUSGABE=0;
        SH='+';
       END
      ELSE
       BEGIN
        AUSGABE=BETRAG;
        EINNAHME=0;
        SH='-';
       END
     END
    IF ((IOPNR IS NOT NULL) AND (UST = 0)) THEN
     BEGIN
      select mwst from buchung where bnr=:iopnr into :UST;
     END 
    IF (not (ARTOP IS NOT NULL AND ARTSOLL=1)) then
     BEGIN
      ISSPLIT=0;
      SUSPEND;
     END
   END
 /* JETZT NOCH DIE SLEV */
 FOR
  select onr, lbnr,betrag,datum,text,belegnr from slevbuch
  where banknr=:gkonto AND OPBETRAG IS NULL and (Datum>=:DTVON AND DATUM<=:DTBIS)
  into :HAUS, :LBNR, :BETRAG, DATUM, BUCHUNGSTEXT, BELEG
  DO
   BEGIN
    select max(kauszugnr) as kausz, max(kauszugblatt) from buchung where lbnr=:lbnr into kausz, blattnr;
    BNR=NULL;
    KONTO=NULL;
    IKONTO=NULL;
    KAUSZ=NULL;
    BLATTNR=NULL;
    UST=NULL;
    IF (BETRAG<0) then
     begin
      EINNAHME=0;
      AUSGABE=-BETRAG;
      SH='-';
     end
    Else
     begin
      SH='+';
      AUSGABE=0;
      EINNAHME=BETRAG;
     end
    IF (HAUS=0) THEN
     HAUS=NULL;
    ISSPLIT=0;
    SUSPEND;
   END
 /* JETZT NOCH DIE SPLITBUCHUNGEN AUSGABEN */
 FOR
  select sum(betrag), artop, count(*) from buchung
  where artop is not null and artsoll=1 and (BANKNRSOLL=:GKONTO or BANKNRHABEN=:GKONTO) AND (Datum>=:DTVON AND DATUM<=:DTBIS)
  group by artop
  into :BETRAG, :ARTOP, :ANZ
  DO
   BEGIN
    SELECT DATUM,BELEGNR,KAUSZUGNR,KAUSZUGBLATT,TEXT,MWST,BNR,LBNR,BANKNRSOLL,BANKNRHABEN, ONRSOLL,ONRHABEN,KSOLL,KHABEN,KSTRSOLL,KSTRHABEN, GN from buchung
    WHERE BNR=:ARTOP
    INTO :DATUM, :BELEG, :KAUSZ,:BLATTNR,:BUCHUNGSTEXT,:UST,:BNR,:LBNR, :IBANKNRSOLL,:IBANKNRHABEN, :ONRSOLL, :ONRHABEN, :KSOLL, :KHABEN, :KSTRSOLL, :KSTRHABEN, :IGN;
    IF (:IBANKNRSOLL=:GKONTO) THEN
     BEGIN
      HAUS=ONRSOLL;
      IKONTO=KHABEN;
      KONTO=KSTRHABEN;
      IF (BETRAG<0) THEN  /* negative einnahme = ausgabe */
       BEGIN
        EINNAHME=0;
        AUSGABE=-BETRAG;
        SH='-';
       END
      ELSE
       BEGIN
        EINNAHME=BETRAG;
        AUSGABE=0;
        SH='+';
       END
     END
    ELSE
     BEGIN
      if (IGN=71) then
       HAUS=ONRSOLL;
      ELSE
       HAUS=ONRHABEN;
      IKONTO=KSOLL;
      KONTO=KSTRSOLL;
      IF (BETRAG<0) THEN /* NEGATIVE AUSGABE = EINNAHME */
       BEGIN
        EINNAHME=-BETRAG;
        AUSGABE=0;
        SH='+';
       END
      ELSE
       BEGIN
        AUSGABE=BETRAG;
        EINNAHME=0;
        SH='-';
       END
      END
     KONTO=KONTO || '+';
     if (char_length(BUCHUNGSTEXT)<45) then
      BUCHUNGSTEXT=BUCHUNGSTEXT || ' (Split auf ' || :ANZ || ' Konten)';
     ISSPLIT=1;
     SUSPEND;
   END /* SPLITBUCH AUSGABEN */
END
