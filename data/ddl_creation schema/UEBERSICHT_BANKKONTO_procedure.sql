-- Prozedur: UEBERSICHT_BANKKONTO
-- Generiert: 2025-05-31 10:26:42

CREATE OR ALTER PROCEDURE UEBERSICHT_BANKKONTO
declare variable ISSPLIT INTEGER;
BEGIN
 KONTOSTAND=:IALTSALDO; 
 UMSATZ=0;
 IF (ISORT=0) THEN
  BEGIN /* Datum sortiert */
   FOR SELECT DATUM,HAUS,IKONTO,KONTO,BELEG,KAUSZ,BLATTNR,BUCHUNGSTEXT,UST,EINNAHME, AUSGABE,SH,BNR,LBNR,ISSPLIT
    from uebersicht_bankkonto_ohne_saldo(:GKONTO, :DTVON, :DTBIS)
    ORDER BY DATUM,BELEG,LBNR,BNR
    INTO DATUM,HAUS,IKONTO,KONTO,BELEG,KAUSZ,BLATTNR,BUCHUNGSTEXT,UST,EINNAHME, AUSGABE,SH,BNR,LBNR,:ISSPLIT
    DO
     BEGIN
      IF (SH='+') THEN
       BEGIN
        KONTOSTAND=KONTOSTAND+EINNAHME;
        UMSATZ=UMSATZ+EINNAHME;
       END
      ELSE
       BEGIN
        KONTOSTAND=KONTOSTAND-AUSGABE;
        UMSATZ=UMSATZ-AUSGABE;
       END
      IF (KONTOSTAND>=0) THEN
       SH_GES='+';
      ELSE
       SH_GES='-';
      IF (UMSATZ>=0) THEN
       SH_UMS='+';
      ELSE
       SH_UMS='-';
      IF (EINNAHME=0) THEN
       EINNAHME=NULL;
      IF (AUSGABE=0) THEN
       AUSGABE=NULL;
      IF (LBNR IS NOT NULL) THEN
       BEMERKUNG='LEV';
      ELSE
       IF (ISSPLIT=1) then
        BEMERKUNG='Split';
       else
        BEMERKUNG='';
      SUSPEND;
     END
  END
 ELSE
  BEGIN  /* BelNr sortiert */
   IF (ISORT=1) THEN
    BEGIN
     FOR SELECT DATUM,HAUS,IKONTO,KONTO,BELEG,KAUSZ,BLATTNR,BUCHUNGSTEXT,UST,EINNAHME, AUSGABE,SH,BNR,LBNR
      from uebersicht_bankkonto_ohne_saldo(:GKONTO, :DTVON, :DTBIS)
      ORDER BY BELEG,DATUM,LBNR,BNR
      INTO DATUM,HAUS,IKONTO,KONTO,BELEG,KAUSZ,BLATTNR,BUCHUNGSTEXT,UST,EINNAHME, AUSGABE,SH,BNR,LBNR
      DO
       BEGIN
        IF (SH='+') THEN
         BEGIN
          KONTOSTAND=KONTOSTAND+EINNAHME;
          UMSATZ=UMSATZ+EINNAHME;
         END
        ELSE
         BEGIN
          KONTOSTAND=KONTOSTAND-AUSGABE;
          UMSATZ=UMSATZ-AUSGABE;
         END
        IF (KONTOSTAND>=0) THEN
         SH_GES='+';
        ELSE
         SH_GES='-';
        IF (UMSATZ>=0) THEN
         SH_UMS='+';
        ELSE
         SH_UMS='-';
        IF (EINNAHME=0) THEN
         EINNAHME=NULL;
        IF (AUSGABE=0) THEN
         AUSGABE=NULL;
        IF (LBNR IS NOT NULL) THEN
         BEMERKUNG='LEV';
        ELSE
         BEMERKUNG='';
        SUSPEND;
       END
    END
   ELSE
    FOR SELECT DATUM,HAUS,IKONTO,KONTO,BELEG,KAUSZ,BLATTNR,BUCHUNGSTEXT,UST,EINNAHME, AUSGABE,SH,BNR,LBNR
     from uebersicht_bankkonto_ohne_saldo(:GKONTO, :DTVON, :DTBIS)
     ORDER BY IKONTO,DATUM,BELEG,LBNR,BNR
     INTO DATUM,HAUS,IKONTO,KONTO,BELEG,KAUSZ,BLATTNR,BUCHUNGSTEXT,UST,EINNAHME, AUSGABE,SH,BNR,LBNR
     DO
      BEGIN
       IF (SH='+') THEN
        BEGIN
         KONTOSTAND=KONTOSTAND+EINNAHME;
         UMSATZ=UMSATZ+EINNAHME;
        END
       ELSE
        BEGIN
         KONTOSTAND=KONTOSTAND-AUSGABE;
         UMSATZ=UMSATZ-AUSGABE;
        END
       IF (KONTOSTAND>=0) THEN
        SH_GES='+';
       ELSE
        SH_GES='-';
       IF (UMSATZ>=0) THEN
        SH_UMS='+';
       ELSE
        SH_UMS='-';
       IF (EINNAHME=0) THEN
        EINNAHME=NULL;
       IF (AUSGABE=0) THEN
        AUSGABE=NULL;
       IF (LBNR IS NOT NULL) THEN
        BEMERKUNG='LEV';
       ELSE
        BEMERKUNG='';
       SUSPEND;
      END
  END
END
