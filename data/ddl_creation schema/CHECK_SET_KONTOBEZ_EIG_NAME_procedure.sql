-- Prozedur: CHECK_SET_KONTOBEZ_EIG_NAME
-- Generiert: 2025-05-31 10:26:41

CREATE OR ALTER PROCEDURE CHECK_SET_KONTOBEZ_EIG_NAME
DECLARE VARIABLE KBEZ_ALT VARCHAR(188);
DECLARE VARIABLE KBEZ_NEU VARCHAR(188);
DECLARE VARIABLE SEBEZ VARCHAR(25);
DECLARE VARIABLE SNAME VARCHAR(80);
DECLARE VARIABLE SVNAME VARCHAR(80);
DECLARE VARIABLE SEFIRMA VARCHAR(1);
DECLARE VARIABLE SEFIRMANAME VARCHAR(80);
DECLARE VARIABLE SEBRIEFAN VARCHAR(40);
BEGIN
 SELECT EBEZ from wohnung WHERE ONR=:IONR and ENR=:IENR INTO :SEBEZ;
 IF (SEBEZ IS NULL) THEN
  SEBEZ = '';
 /* */ 
 IF (IEIGNR IS NOT NULL) THEN
  BEGIN
   SELECT ENAME, EVNAME, EFIRMA, EFIRMANAME, EBRIEFAN  FROM eigadr WHERE EIGNR=:IEIGNR INTO :SNAME, :SVNAME, :SEFIRMA, :SEFIRMANAME, :SEBRIEFAN;
   IF ((SEFIRMA = 'N') OR (SEFIRMA IS NULL)) THEN
    BEGIN 
     IF (SNAME IS NULL) THEN
      SNAME = '';
     IF (SVNAME IS NULL) THEN
      SVNAME = ''; 
     IF (SNAME = '') THEN
      KBEZ_NEU = SVNAME;
     ELSE
      KBEZ_NEU = SNAME || ', ' || SVNAME;
    END
   ELSE
    BEGIN
     IF (SEBRIEFAN = 'Sehr geehrte Damen und Herren') THEN
      KBEZ_NEU = SEFIRMANAME;
     ELSE 
      BEGIN
       IF (SEFIRMANAME IS NULL) THEN
        SEFIRMANAME = '';
       IF (SNAME IS NULL) THEN
        SNAME = '';
       IF (SVNAME IS NULL) THEN
        SVNAME = ''; 
       IF (SEFIRMANAME <> '') THEN
        KBEZ_NEU = SEFIRMANAME || ';'; 
        
       IF (SNAME = '') THEN
        KBEZ_NEU = KBEZ_NEU || ' ' || SVNAME;
       ELSE
        KBEZ_NEU = KBEZ_NEU || ' ' || SNAME || ', ' || SVNAME;
      END 
    END  
     
   IF (SEBEZ <> '') THEN
      IF (KBEZ_NEU = '') THEN
       KBEZ_NEU = SEBEZ;
      ELSE
       KBEZ_NEU = KBEZ_NEU || ' ' || SEBEZ;  
     
     
  END
 ELSE
  KBEZ_NEU = 'Unbelegt';
  
 SELECT KBEZ from konten WHERE ONR=:IONR and KNR=:IKNR INTO :KBEZ_ALT;
 IF (KBEZ_ALT IS NULL) THEN
  KBEZ_ALT = ''; 
 IF (KBEZ_ALT <> KBEZ_NEU) THEN
  update konten set konten.kbez = :KBEZ_NEU where ONR=:IONR and KNR=:IKNR;
END
