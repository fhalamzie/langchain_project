-- Prozedur: OFFENE_SOLLSTELLUNGEN_DIREKT
-- Generiert: 2025-05-31 10:26:42

CREATE OR ALTER PROCEDURE OFFENE_SOLLSTELLUNGEN_DIREKT
DECLARE VARIABLE ONRSOLL INTEGER;
 DECLARE VARIABLE ONRHABEN INTEGER;
 DECLARE VARIABLE KSOLL INTEGER;
 DECLARE VARIABLE KHABEN INTEGER;
 DECLARE VARIABLE ARTSOLL INTEGER;
 DECLARE VARIABLE ARTHABEN INTEGER;
 DECLARE VARIABLE KSTRSOLL VARCHAR(15);
 DECLARE VARIABLE KSTRHABEN VARCHAR(15);
BEGIN
 SUMMEOP=0;
 FOR SELECT
    Datum, ONRSOLL, KSOLL, KSTRSOLL, ARTSOLL, ONRHABEN, KHABEN, KSTRHABEN, ARTHABEN, TEXT, BNR, LBNR, OPBetrag, Betrag, Mwst, SPLITNR, LASTERZEUGT,GN, LASTBANK from buchung
    WHERE BNR=:IBNR and SPLITNR IS NULL
   UNION
    SELECT Datum, ONRSOLL, KSOLL, KSTRSOLL, ARTSOLL, ONRHABEN, KHABEN, KSTRHABEN, ARTHABEN, TEXT, splitbuch.BNR, LBNR, splitbuch.OPBetrag, splitbuch.Betrag, Mwst, SPLITNR, LASTERZEUGT, GN, LASTBANK from buchung, splitbuch
    WHERE buchung.bnr=:IBNR AND (SPLITNR IS NOT NULL)   and buchung.bnr=splitbuch.bnr
    INTO :DATUM, :ONRSOLL, :KSOLL, :KSTRSOLL, :ARTSOLL, :ONRHABEN, :KHABEN, :KSTRHABEN, :ARTHABEN, :TEXT, :BNR, :LBNR, :OPBETRAG, :OPGESBETRAG, :MWST, :SPLITNR, :LASTERZEUGT, :GN, :LASTBANK
    DO
     BEGIN
      OPRESTBETRAG=OPGESBETRAG-OPBETRAG;
      IF (LASTERZEUGT IS NULL) THEN
       LASTERZEUGT=0;
      IF ((ARTSOLL>=60 AND ARTSOLL<=64) or (ARTHABEN>=60 AND ARTHABEN<=64)) THEN
       BEGIN
        ISDEBITOR=1;
        IF (ARTSOLL>=60 AND ARTSOLL<=64) THEN
         BEGIN
          ONR=ONRSOLL;
          KNR=KSOLL;
          KNRSTR=KSTRSOLL;
          KKLASSE=ARTSOLL;
          KNROP=KHABEN;
          ARTOP=ARTHABEN;
         END
        ELSE
         BEGIN
          ONR=ONRHABEN;
          KNR=KHABEN;
          KNRSTR=KSTRHABEN;
          KKLASSE=ARTHABEN;
          KNROP=KSOLL;
          ARTOP=ARTSOLL;
         END
        SUMMEOP=SUMMEOP+OPGESBETRAG;
        IF (LBNR IS NOT NULL) THEN
         BEGIN
          BEMERKUNG='DTA';
          TEXT='[S] ' || TEXT;
         END
        ELSE
         IF (SPLITNR IS NOT NULL) THEN
          BEGIN
           BEMERKUNG='OP..';
          END
         ELSE
          BEMERKUNG='OP';
        SUSPEND;
       END /* DEBITOREN OP */
      ELSE
      /* KREDITOREN OP */
      IF (ARTSOLL=71 or ARTHABEN=71) THEN
       BEGIN
        ISDEBITOR=2;
        IF (ARTSOLL=71) THEN
         BEGIN
          ONR=ONRHABEN;
          KNR=KSOLL;
          KNRSTR=KSTRSOLL;
          KKLASSE=ARTSOLL;
          ARTOP=ARTHABEN;
          KNROP=KHABEN;
         END
        ELSE
         BEGIN
          ONR=ONRSOLL;
          KNR=KHABEN;
          KNRSTR=KSTRHABEN;
          KKLASSE=ARTHABEN;
          ARTOP=ARTSOLL;
          KNROP=KSOLL;
         END
        LASTERZEUGT=-1;
        SUMMEOP=SUMMEOP+OPGESBETRAG;
        IF (LBNR IS NOT NULL) THEN
         BEGIN
          BEMERKUNG='DTA';
          TEXT='[S] ' || TEXT;
         END
        ELSE
         IF (SPLITNR IS NOT NULL) THEN
          BEGIN
           BEMERKUNG='OP..';
          END
         ELSE
          BEMERKUNG='OP';
        SUSPEND;
       END /* KREDITOREN OP */
     END
END
