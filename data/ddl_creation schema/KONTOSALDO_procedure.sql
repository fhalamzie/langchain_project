-- Prozedur: KONTOSALDO
-- Generiert: 2025-05-31 10:26:42

CREATE OR ALTER PROCEDURE KONTOSALDO
DECLARE VARIABLE KKLASSE INTEGER;
DECLARE VARIABLE SUMSOLL NUMERIC(15, 2);
DECLARE VARIABLE SUMHABEN NUMERIC(15, 2);
DECLARE VARIABLE SUMSOLL_NETTO NUMERIC(15, 2);
DECLARE VARIABLE SUMHABEN_NETTO NUMERIC(15, 2);
DECLARE VARIABLE IGN_V SMALLINT;
DECLARE VARIABLE IGN_B SMALLINT;
DECLARE VARIABLE DTBDATUMVON DATE;
DECLARE VARIABLE DTBDATUMBIS DATE;
DECLARE VARIABLE DTWDATUMVON DATE;
DECLARE VARIABLE DTWDATUMBIS DATE;
BEGIN
 select KKLASSE from konten where ONR=:IONR and KNR=:IKNR INTO KKLASSE;
 /* */
 IF ((IKNR=60090) OR (IKNR=60190)) THEN
  BEGIN
   IGN_V=1;
   IGN_B=1;
  END 
 ELSE
  BEGIN
   IGN_V=0;
   IGN_B=71;
  END
 /* Datum */ 
 if (BWDATUM = 'N') then
  begin
   DTBDATUMVON = DTVON;
   DTBDATUMBIS = DTBIS;
   DTWDATUMVON = '01.01.1900';
   DTWDATUMBIS = '01.01.1900';
  end
 else
  begin
   DTWDATUMVON = DTVON;
   DTWDATUMBIS = DTBIS;
   DTBDATUMVON = '01.01.1900';
   DTBDATUMBIS = '01.01.1900';
  end   
 /* Buchungen */
 SELECT SUM(BETRAG), SUM((Betrag*100) / (100+MWST)) from buchung WHERE ONRSOLL=:IONR and KSOLL=:IKNR and ((GN=:IGN_V) OR (GN=:IGN_B)) AND ((DATUM>=:DTBDATUMVON and DATUM<=:DTBDATUMBIS) or (WDATUM>=:DTWDATUMVON and WDATUM<=:DTWDATUMBIS))
 INTO :SUMSOLL, SUMSOLL_NETTO;
 SELECT SUM(BETRAG), SUM((Betrag*100) / (100+MWST)) from buchung WHERE ONRHABEN=:IONR and KHABEN=:IKNR and ((GN=:IGN_V) OR (GN=:IGN_B)) AND ((DATUM>=:DTBDATUMVON and DATUM<=:DTBDATUMBIS) or (WDATUM>=:DTWDATUMVON and WDATUM<=:DTWDATUMBIS))
 INTO :SUMHABEN, SUMHABEN_NETTO;
 /* Summe */
 IF (SUMSOLL IS NULL) THEN
  SUMSOLL=0;
 IF (SUMHABEN IS NULL) THEN
  SUMHABEN=0;
 IF (SUMSOLL_NETTO IS NULL) THEN
  SUMSOLL_NETTO=0;
 IF (SUMHABEN_NETTO IS NULL) THEN
  SUMHABEN_NETTO=0;
 /* Ergebnis */
 IF ((KKLASSE>=10 AND KKLASSE<=19) OR KKLASSE=27) THEN
  BEGIN
   SALDO=SUMHABEN-SUMSOLL;
   SALDONETTO=SUMHABEN_NETTO-SUMSOLL_NETTO;
  END
 ELSE
  BEGIN
   SALDO=SUMSOLL-SUMHABEN;
   SALDONETTO=SUMSOLL_NETTO-SUMHABEN_NETTO;
  END
 SUSPEND;
END
