-- Prozedur: CHECK_SET_KONTOBEZ_BE_NAME
-- Generiert: 2025-05-31 10:26:41

CREATE OR ALTER PROCEDURE CHECK_SET_KONTOBEZ_BE_NAME
DECLARE VARIABLE KBEZ_ALT VARCHAR(188);
DECLARE VARIABLE KBEZ_NEU VARCHAR(188);
DECLARE VARIABLE SEBEZ VARCHAR(25);
DECLARE VARIABLE SNAME VARCHAR(80);
DECLARE VARIABLE SVNAME VARCHAR(80);
DECLARE VARIABLE SBFIRMA VARCHAR(1);
DECLARE VARIABLE SBFIRMANAME VARCHAR(80);
DECLARE VARIABLE SBBRIEFAN VARCHAR(40);
DECLARE VARIABLE BEWSTATUS INTEGER;
BEGIN
 SELECT EBEZ from wohnung WHERE ONR=:IONR and ENR=:IENR INTO :SEBEZ;
 IF (SEBEZ IS NULL) THEN
  SEBEZ = '';
  
 select BEWSTATUS from BEWOHNER where ONR=:IONR and KNR=:IKNR INTO :BEWSTATUS;
 /* */ 
 IF (IBEWNR IS NOT NULL) THEN
  BEGIN
   SELECT BNAME, BVNAME, BFIRMA, BFIRMANAME, BBRIEFAN FROM bewadr WHERE BEWNR=:IBEWNR INTO :SNAME, :SVNAME, :SBFIRMA, :SBFIRMANAME, :SBBRIEFAN;
   IF ((SBFIRMA = 'N') OR (SBFIRMA IS NULL)) THEN
    BEGIN
     IF (SNAME IS NULL) THEN
      SNAME = '';
     IF (SVNAME IS NULL) THEN
      SVNAME = ''; 
     IF (SNAME = '') THEN
      KBEZ_NEU = SVNAME;
     ELSE
      KBEZ_NEU = SNAME || ', ' || SVNAME;
    END
   ELSE
    BEGIN
     IF (sBBRIEFAN = 'Sehr geehrte Damen und Herren') THEN
      KBEZ_NEU = SBFIRMANAME;
     ELSE 
      BEGIN
       IF (sBFIRMANAME IS NULL) THEN
        SBFIRMANAME = '';
       IF (SNAME IS NULL) THEN
        SNAME = '';
       IF (SVNAME IS NULL) THEN
        SVNAME = ''; 
        
       IF (SBFIRMANAME <> '') THEN
        KBEZ_NEU = SBFIRMANAME || ';'; 
        
       IF (SNAME = '') THEN
        KBEZ_NEU = KBEZ_NEU || ' ' || SVNAME;
       ELSE
        KBEZ_NEU = KBEZ_NEU || ' ' || SNAME || ', ' || SVNAME;
      END 
    END 
      
   
   IF (SEBEZ <> '') THEN
    IF (BEWSTATUS = 0) THEN
     BEGIN    
      IF (KBEZ_NEU = '') THEN
       KBEZ_NEU = SEBEZ;
      ELSE
       KBEZ_NEU = KBEZ_NEU || ' ' || SEBEZ;
     END
    ELSE
     KBEZ_NEU = 'Leerstand ' || SEBEZ;
     
  END
 ELSE
  KBEZ_NEU = 'Unbelegt';
  
 SELECT KBEZ from konten WHERE ONR=:IONR and KNR=:IKNR INTO :KBEZ_ALT;
 IF (KBEZ_ALT IS NULL) THEN
  KBEZ_ALT = ''; 
 IF (KBEZ_ALT <> KBEZ_NEU) THEN
  update konten set konten.kbez = :KBEZ_NEU where ONR=:IONR and KNR=:IKNR;
END
