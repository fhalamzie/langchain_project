-- Prozedur: JOURNAL_EINAUS_K
-- Generiert: 2025-05-31 10:26:41

CREATE OR ALTER PROCEDURE JOURNAL_EINAUS_K
DECLARE VARIABLE BANKNRSOLL INTEGER;
DECLARE VARIABLE BANKNRHABEN INTEGER;
DECLARE VARIABLE ARTSOLL INTEGER;
DECLARE VARIABLE ARTHABEN INTEGER;
DECLARE VARIABLE SPLITNR INTEGER;
DECLARE VARIABLE LEVBANKSTR VARCHAR(15);
DECLARE VARIABLE LEVBANK2STR VARCHAR(15);
DECLARE VARIABLE LEVBANKNR INTEGER;
DECLARE VARIABLE LEVBANK2NR INTEGER;
DECLARE VARIABLE TEMPSTR VARCHAR(15);
DECLARE VARIABLE KTEMPHABEN INTEGER;
DECLARE VARIABLE DUMMY INTEGER;
DECLARE VARIABLE KNROP INTEGER;
DECLARE VARIABLE MWSTOP NUMERIC(15, 2);
BEGIN
 SELECT NR, KURZBEZ FROM BANKEN WHERE NR IN (SELECT LEVBANKNR FROM OBJEKTE WHERE ONR=:IONR) INTO :LEVBANKNR, :LEVBANKSTR;
 SELECT NR, KURZBEZ FROM BANKEN WHERE NR IN (SELECT LEVBANKNR2 FROM OBJEKTE WHERE ONR=:IONR) INTO :LEVBANK2NR, :LEVBANK2STR;
 /* BUCHUNGEN */
 FOR
  SELECT BNR, DATUM, WDATUM, KSOLL, KHABEN, BELEGNR, TEXT, MWST, BETRAG, BANKNRSOLL, BANKNRHABEN, SPLITNR, KSTRHABEN, KSTRSOLL, ARTSOLL, ARTHABEN, MWSTOP, KNROP from buchung
  WHERE (ONRSOLL=:IONR OR ONRHABEN=:IONR) AND (KSOLL=:KNR OR KHABEN=:KNR) AND OPBETRAG IS NULL AND (Datum>=:DTVON and Datum<=:DTBIS) and BETRAG<>0
 INTO :BNR, :DATUM, :WDATUM, :KSOLL, :KHABEN, :BELEGNR, :TEXT, :MWST, :BETRAG, :BANKNRSOLL, :BANKNRHABEN, :SPLITNR, :KSTRHABEN, :KSTRSOLL, :ARTSOLL, :ARTHABEN, :MWSTOP, :KNROP
 DO
  BEGIN
   ONR=:IONR;
   IF (BANKNRSOLL IS NOT NULL) THEN
    BEGIN
     IF (BANKNRSOLL=LEVBANKNR) THEN
      KSTRSOLL=KSTRSOLL || ' ' || LEVBANKSTR;
     ELSE
      IF (BANKNRSOLL=LEVBANK2NR) THEN
       KSTRSOLL=KSTRSOLL || ' ' || LEVBANKSTR;
      ELSE
       BEGIN
        SELECT KURZBEZ from Banken where NR=:BANKNRSOLL into :TEMPSTR;
        KSTRSOLL=KSTRSOLL || ' ' || TEMPSTR;
       END
    END
   ELSE
    BEGIN
     SELECT KNRSTR || ' ' || KBEZ from konten where ONR=:IONR AND KNR=:KSOLL INTO :KSTRSOLL;
    END
   IF (BANKNRHABEN IS NOT NULL) THEN
    BEGIN
     IF (BANKNRHABEN=LEVBANKNR) THEN
      KSTRHABEN=KSTRHABEN || ' ' || LEVBANKSTR;
     ELSE
      IF (BANKNRHABEN=LEVBANK2NR) THEN
       KSTRHABEN=KSTRHABEN || ' ' || LEVBANKSTR;
      ELSE
       BEGIN
        SELECT KURZBEZ from Banken where NR=:BANKNRHABEN into :TEMPSTR;
        KSTRHABEN=KSTRHABEN || ' ' || TEMPSTR;
       END
    END
   ELSE
    SELECT KNRSTR || ' ' || KBEZ from konten where ONR=:IONR AND KNR=:KHABEN INTO :KSTRHABEN;
   IF ((ARTSOLL=19 AND ARTHABEN=19) or (ARTSOLL=1 AND ARTHABEN=1)) THEN
    BEGIN
     IF (KHABEN=KNR) THEN
      BETRAG=-BETRAG;
    END
   ELSE
    IF ((ARTSOLL=19) or (ARTHABEN=1)) THEN
     BETRAG=-BETRAG;
   /*Rene Verrechnungen*/
   IF ((KLASSE>=60 AND KLASSE<=64) OR (KLASSE=19)) THEN
    BEGIN
     IF (BANKNRSOLL IS NULL AND BANKNRHABEN IS NULL) THEN
      BEGIN /* VERRECHNUNG */
       IF ((ARTSOLL=24) OR (ARTSOLL=27) OR (ARTSOLL=30)) THEN
        BETRAG=BETRAG;
       ELSE
        BETRAG=-BETRAG;
      END
    END
   IF (MWSTOP IS NOT NULL) THEN
    IF (MWSTOP>0) THEN
     MWST=MWSTOP;
    ELSE
     BEGIN
      IF ((KLASSE>=60 AND KLASSE<=64) OR (KLASSE=19)) THEN
       SELECT FIRST 1 MWSTOP FROM BUCHZAHL WHERE BNR=:BNR INTO :MWST;
     END
   suspend;
  END
 /* LIEFERANTEN-BUCHUNGEN */
 FOR
  SELECT BNR, DATUM, WDATUM, KSOLL, KHABEN, BELEGNR, TEXT, MWSTOP, BETRAG, BANKNRSOLL, BANKNRHABEN, SPLITNR, KSTRHABEN, KSTRSOLL, ARTSOLL, ARTHABEN, MWSTOP, KNROP from buchung
  WHERE (ONRSOLL=:IONR OR ONRHABEN=:IONR) AND (ARTSOLL=71 OR ARTHABEN=71) AND OPBETRAG IS NULL AND (Datum>=:DTVON and Datum<=:DTBIS) and BETRAG<>0 and knrop=:knr
  union all
  SELECT buchung.BNR, DATUM, WDATUM, KSOLL, KHABEN, BELEGNR, TEXT, MWST, BUCHZAHL.BETRAG, BANKNRSOLL, BANKNRHABEN, SPLITNR, KSTRHABEN, KSTRSOLL, ARTSOLL, ARTHABEN, buchung.MWSTOP, KNROP from buchung, buchzahl
  WHERE (ONRSOLL=:IONR OR ONRHABEN=:IONR) AND (ARTSOLL=71 OR ARTHABEN=71) AND OPBETRAG IS NULL AND (Datum>=:DTVON and Datum<=:DTBIS) and buchung.BETRAG<>0 and knrop=0
  and BUCHZAHL.bnr=buchung.bnr and buchzahl.KNR=:knr
 INTO :BNR, :DATUM, :WDATUM, :KSOLL, :KHABEN, :BELEGNR, :TEXT, :MWST, :BETRAG, :BANKNRSOLL, :BANKNRHABEN, :SPLITNR, :KSTRHABEN, :KSTRSOLL, :ARTSOLL, :ARTHABEN, :MWSTOP, :KNROP
 DO
  BEGIN
   ONR=:IONR;
   IF ((KLASSE=19)) THEN
    BETRAG = -BETRAG; 
   suspend; 
  END  
END
