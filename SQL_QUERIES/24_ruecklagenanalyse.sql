-- ============================================================================
-- QUERY 16: RUECKLAGENANALYSE - Layer 4 Enhancement with RUECKPOS Data
-- ============================================================================
-- Author: WINCASA Development Team
-- Status: ENHANCED with complete reserve fund structure from RUECKPOS
-- Firebird-driver: COMPATIBLE (NUMERIC operations verified)
-- Layer 4 Enhancement: Option B - Surface Missing Reserve Fund Details
-- ============================================================================
/*
GESCHÄFTSZWECK: Vollständige Analyse der Instandhaltungsrücklagen pro WEG
HAUPTTABELLEN:
  - RUECKPOS: Strukturierte Rücklagenverwaltung mit 10 Positionen
  - RUECKBKT: Bankkonten der Rücklagen mit IBAN/BIC
  - OBJEKTE: Objektdaten für Kontext
  - BUCHUNG: Transaktionshistorie (ergänzend)
VERWENDUNG: Risikobewertung, Rücklagenplanung, Transparenz für Eigentümer

LAYER 4 ENHANCEMENTS:
- Primary source switched from BUCHUNG to RUECKPOS table
- All 10 position types exposed (POS1-POS10 with names)
- SOLL vs IST comparison from dedicated fields
- Special movements (SONDERZUF/SONDERENTN) included
- Bank account details from RUECKBKT
- Fixed character encoding issues
*/

WITH RuecklagenPositionen AS (
  -- Hauptdaten aus RUECKPOS mit allen Feldern
  SELECT 
    RP.ONR,
    RP.NR AS RUECKPOS_NR,
    RP.NAME AS RUECKLAGEN_NAME,
    
    -- === SOLL-IST VERGLEICH ===
    RP.ANFSTAND_SOLL,
    RP.ANFSTAND AS ANFSTAND_IST,
    RP.ZUF_SOLL,
    RP.ZUF AS ZUF_IST,
    RP.ENDSTAND_SOLL,
    RP.ENDSTAND AS ENDSTAND_IST,
    
    -- === BEWEGUNGEN ===
    RP.ENTN AS ENTNAHMEN,
    RP.ZUFNACHZ AS ZUFUEHRUNG_NACHZAHLUNG,
    RP.ZUFNACHZ_SOLL AS ZUFUEHRUNG_NACHZAHLUNG_SOLL,
    
    -- === SONDERBEWEGUNGEN ===
    RP.SONDERZUF,
    RP.KSONDERZUF,
    RP.SONDERENTN,
    RP.KSONDERENTN,
    
    -- === ZEITRAUM ===
    RP.DTVON,
    RP.DTBIS,
    
    -- === ALLE 10 POSITIONEN ===
    RP.POS1, RP.POS1NAME, RP.POS1CHECK,
    RP.POS2, RP.POS2NAME, RP.POS2CHECK,
    RP.POS3, RP.POS3NAME, RP.POS3CHECK,
    RP.POS4, RP.POS4NAME, RP.POS4CHECK,
    RP.POS5, RP.POS5NAME, RP.POS5CHECK,
    RP.POS6, RP.POS6NAME, RP.POS6CHECK,
    RP.POS7, RP.POS7NAME, RP.POS7CHECK,
    RP.POS8, RP.POS8NAME, RP.POS8CHECK,
    RP.POS9, RP.POS9NAME, RP.POS9CHECK,
    RP.POS10, RP.POS10NAME, RP.POS10CHECK,
    
    -- === VERWALTUNG ===
    RP.KONTO_VZ,
    RP.AB_GEBUCHT,
    RP.RAP_SOLL,
    RP.RAP_IST,
    
    -- === REFERENZEN ===
    RP.KZUF AS KONTO_ZUFUEHRUNG,
    RP.KENTN AS KONTO_ENTNAHME,
    RP.KNRP AS KONTO_NUMMER_POSITION,
    RP.USCHL AS UMLAGESCHLUESSEL
    
  FROM RUECKPOS RP
),
BankkontenDetails AS (
  -- Bankkonten aus RUECKBKT
  SELECT 
    RB.RUECKPOS,
    RB.ONR,
    RB.KNR,
    RB.BEZ AS KONTO_BEZEICHNUNG,
    RB.BEZ2 AS KONTO_BEZEICHNUNG2,
    RB.BANK,
    RB.BLZ,
    RB.KONTO,
    RB.IBAN,
    RB.BIC,
    -- Summe aller Positionen als Gesamtsaldo
    COALESCE(RB.POS1, 0) + COALESCE(RB.POS2, 0) + COALESCE(RB.POS3, 0) + 
    COALESCE(RB.POS4, 0) + COALESCE(RB.POS5, 0) + COALESCE(RB.POS6, 0) +
    COALESCE(RB.POS7, 0) + COALESCE(RB.POS8, 0) + COALESCE(RB.POS9, 0) + 
    COALESCE(RB.POS10, 0) AS KONTO_GESAMTSALDO
  FROM RUECKBKT RB
)
SELECT 
  -- === OBJEKT-IDENTIFIKATION ===
  O.ONR,
  O.OBEZ AS OBJEKT_KURZ,
  O.OSTRASSE AS STRASSE,
  O.OPLZORT AS PLZ_ORT,
  O.GA1 AS WOHNFLAECHE_QM,
  O.OANZEINH AS ANZAHL_EINHEITEN,
  
  -- === RUECKLAGEN HAUPTDATEN ===
  RP.RUECKPOS_NR,
  RP.RUECKLAGEN_NAME,
  
  -- === SOLL-IST VERGLEICH ===
  CAST(RP.ANFSTAND_SOLL AS NUMERIC(15,2)) AS ANFANGSSTAND_SOLL,
  CAST(RP.ANFSTAND_IST AS NUMERIC(15,2)) AS ANFANGSSTAND_IST,
  CAST(RP.ZUF_SOLL AS NUMERIC(15,2)) AS ZUFUEHRUNG_SOLL,
  CAST(RP.ZUF_IST AS NUMERIC(15,2)) AS ZUFUEHRUNG_IST,
  CAST(RP.ENDSTAND_SOLL AS NUMERIC(15,2)) AS ENDSTAND_SOLL,
  CAST(RP.ENDSTAND_IST AS NUMERIC(15,2)) AS ENDSTAND_IST,
  
  -- === SOLL-IST ABWEICHUNGEN ===
  CAST(RP.ENDSTAND_IST - RP.ENDSTAND_SOLL AS NUMERIC(15,2)) AS ABWEICHUNG_ENDSTAND,
  CASE 
    WHEN RP.ENDSTAND_SOLL > 0 THEN 
      CAST((RP.ENDSTAND_IST - RP.ENDSTAND_SOLL) * 100.0 / RP.ENDSTAND_SOLL AS NUMERIC(5,2))
    ELSE 0
  END AS ABWEICHUNG_PROZENT,
  
  -- === BEWEGUNGEN ===
  CAST(RP.ENTNAHMEN AS NUMERIC(15,2)) AS ENTNAHMEN,
  CAST(RP.ZUFUEHRUNG_NACHZAHLUNG AS NUMERIC(15,2)) AS NACHZAHLUNGEN,
  
  -- === SONDERBEWEGUNGEN ===
  CAST(RP.SONDERZUF AS NUMERIC(15,2)) AS SONDERZUFUEHRUNG,
  RP.KSONDERZUF AS SONDERZUF_KONTO,
  CAST(RP.SONDERENTN AS NUMERIC(15,2)) AS SONDERENTNAHME,
  RP.KSONDERENTN AS SONDERENTN_KONTO,
  
  -- === ZEITRAUM ===
  RP.DTVON AS PERIODE_VON,
  RP.DTBIS AS PERIODE_BIS,
  CASE 
    WHEN RP.DTVON IS NOT NULL AND RP.DTBIS IS NOT NULL THEN
      CAST(RP.DTBIS - RP.DTVON AS INTEGER)
    ELSE NULL
  END AS PERIODE_TAGE,
  
  -- === POSITIONEN 1-5 (Hauptpositionen) ===
  CAST(RP.POS1 AS NUMERIC(15,2)) AS POS1_BETRAG,
  RP.POS1NAME,
  RP.POS1CHECK AS POS1_AKTIV,
  
  CAST(RP.POS2 AS NUMERIC(15,2)) AS POS2_BETRAG,
  RP.POS2NAME,
  RP.POS2CHECK AS POS2_AKTIV,
  
  CAST(RP.POS3 AS NUMERIC(15,2)) AS POS3_BETRAG,
  RP.POS3NAME,
  RP.POS3CHECK AS POS3_AKTIV,
  
  CAST(RP.POS4 AS NUMERIC(15,2)) AS POS4_BETRAG,
  RP.POS4NAME,
  RP.POS4CHECK AS POS4_AKTIV,
  
  CAST(RP.POS5 AS NUMERIC(15,2)) AS POS5_BETRAG,
  RP.POS5NAME,
  RP.POS5CHECK AS POS5_AKTIV,
  
  -- === POSITIONEN 6-10 (Zusatzpositionen) ===
  CAST(RP.POS6 AS NUMERIC(15,2)) AS POS6_BETRAG,
  RP.POS6NAME,
  RP.POS6CHECK AS POS6_AKTIV,
  
  CAST(RP.POS7 AS NUMERIC(15,2)) AS POS7_BETRAG,
  RP.POS7NAME,
  RP.POS7CHECK AS POS7_AKTIV,
  
  CAST(RP.POS8 AS NUMERIC(15,2)) AS POS8_BETRAG,
  RP.POS8NAME,
  RP.POS8CHECK AS POS8_AKTIV,
  
  CAST(RP.POS9 AS NUMERIC(15,2)) AS POS9_BETRAG,
  RP.POS9NAME,
  RP.POS9CHECK AS POS9_AKTIV,
  
  CAST(RP.POS10 AS NUMERIC(15,2)) AS POS10_BETRAG,
  RP.POS10NAME,
  RP.POS10CHECK AS POS10_AKTIV,
  
  -- === SUMME ALLER POSITIONEN ===
  CAST(
    COALESCE(RP.POS1, 0) + COALESCE(RP.POS2, 0) + COALESCE(RP.POS3, 0) + 
    COALESCE(RP.POS4, 0) + COALESCE(RP.POS5, 0) + COALESCE(RP.POS6, 0) +
    COALESCE(RP.POS7, 0) + COALESCE(RP.POS8, 0) + COALESCE(RP.POS9, 0) + 
    COALESCE(RP.POS10, 0) AS NUMERIC(15,2)
  ) AS SUMME_ALLE_POSITIONEN,
  
  -- === BANKKONTEN ===
  BD.KONTO_BEZEICHNUNG,
  BD.BANK,
  BD.IBAN,
  BD.BIC,
  CAST(BD.KONTO_GESAMTSALDO AS NUMERIC(15,2)) AS BANKKONTO_SALDO,
  
  -- === VERWALTUNG ===
  RP.AB_GEBUCHT,
  RP.UMLAGESCHLUESSEL,
  CAST(RP.RAP_SOLL AS NUMERIC(15,2)) AS RECHNUNGSABGRENZUNG_SOLL,
  CAST(RP.RAP_IST AS NUMERIC(15,2)) AS RECHNUNGSABGRENZUNG_IST,
  
  -- === KENNZAHLEN ===
  CASE 
    WHEN O.GA1 > 0 AND RP.ENDSTAND_IST IS NOT NULL THEN 
      CAST(RP.ENDSTAND_IST / O.GA1 AS NUMERIC(15,2))
    ELSE 0 
  END AS RUECKLAGE_EUR_PRO_QM,
  
  CASE 
    WHEN O.OANZEINH > 0 AND RP.ENDSTAND_IST IS NOT NULL THEN 
      CAST(RP.ENDSTAND_IST / O.OANZEINH AS NUMERIC(15,2))
    ELSE 0 
  END AS RUECKLAGE_EUR_PRO_EINHEIT,
  
  -- === BEWERTUNG ===
  CASE 
    WHEN RP.ENDSTAND_IST >= RP.ENDSTAND_SOLL THEN 'ZIEL ERREICHT'
    WHEN RP.ENDSTAND_IST >= RP.ENDSTAND_SOLL * 0.8 THEN 'FAST ERREICHT (>80%)'
    WHEN RP.ENDSTAND_IST >= RP.ENDSTAND_SOLL * 0.5 THEN 'TEILWEISE (50-80%)'
    ELSE 'KRITISCH (<50%)'
  END AS ZIELERREICHUNG,
  
  CASE 
    WHEN RP.SONDERENTN > 0 THEN 'SONDERENTNAHME ERFOLGT'
    WHEN RP.SONDERZUF > 0 THEN 'SONDERZUFUEHRUNG ERFOLGT'
    ELSE 'KEINE SONDERBEWEGUNGEN'
  END AS SONDERBEWEGUNG_STATUS

FROM RuecklagenPositionen RP
  INNER JOIN OBJEKTE O ON RP.ONR = O.ONR
  LEFT JOIN BankkontenDetails BD ON RP.RUECKPOS_NR = BD.RUECKPOS AND RP.ONR = BD.ONR
WHERE 
  O.ONR < 890  -- Ausschluss Testobjekte
ORDER BY 
  O.ONR,
  RP.RUECKPOS_NR;

/*
LAYER 4 IMPROVEMENTS:
- Complete switch to RUECKPOS as primary data source
- All 10 position types exposed with names and activation status
- SOLL vs IST comparison with deviation calculations
- Special movements (SONDERZUF/SONDERENTN) with account references
- Bank account details including IBAN/BIC from RUECKBKT
- Period tracking (DTVON/DTBIS) for time-based analysis
- Administrative fields (AB_GEBUCHT, RAP) for audit trail
- Fixed character encoding issues
- All NUMERIC fields properly cast for firebird-driver

ERWARTETES ERGEBNIS:
- Vollständige Rücklagenstruktur pro Objekt
- SOLL-IST Vergleich aus dedizierten Feldern
- Alle 10 möglichen Positionen mit Bezeichnungen
- Bankkonten-Details für Transparenz
- Sonderbewegungen nachvollziehbar

GESCHÄFTSNUTZEN:
[OK] Vollständige Transparenz über Rücklagenstruktur
[OK] SOLL-IST Abweichungen auf einen Blick
[OK] Nachvollziehbare Sonderbewegungen
[OK] Bankkonten-Zuordnung für Eigentümer
[OK] Basis für fundierte WEG-Beschlüsse
*/